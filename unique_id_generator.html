<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Unique ID Generator (Bridge)</title>
  <style>
    body {
      font-family: system-ui, Segoe UI, Roboto, Arial;
      padding: 18px;
      background: #0f172a;
      color: #f8fafc;
    }
    h2 {
      margin-bottom: 10px;
      color: #38bdf8;
    }
    #status {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h2>Unique ID Bridge (Parent)</h2>
  <p id="status">Android ID: <em id="aid">not set</em></p>

  <script>
    (function () {
      // Store android id here when native sets it
      let androidId = null;

      // Registry of connected clients. Each entry: { source, origin }
      const clients = new Set();

      // Helper to send message safely to a client entry
      function sendToClient(client, message) {
        try {
          client.source.postMessage(message, client.origin || '*');
        } catch (e) {
          console.warn('Failed to postMessage to client', e);
        }
      }

      // Broadcast to all registered clients
      function broadcast(message) {
        clients.forEach(client => sendToClient(client, message));
      }

      // Public function native can call: window.setAndroidId('...')
      window.setAndroidId = function (id) {
        androidId = id || null;
        document.getElementById('aid').textContent = androidId || 'null';
        broadcast({ type: 'ANDROID_ID', id: androidId });
      };

      // Listen for messages from children (portal or others)
      window.addEventListener(
        'message',
        function (event) {
          const data = event.data;
          if (!data || typeof data.type !== 'string') return;

          switch (data.type) {
            // Child registers itself
            case 'REGISTER_ANDROID_BRIDGE': {
              const client = { source: event.source, origin: event.origin };
              let exists = false;
              clients.forEach(c => {
                if (c.source === event.source) exists = true;
              });
              if (!exists) clients.add(client);

              // Acknowledge registration
              sendToClient(client, { type: 'BRIDGE_REGISTERED', ok: true });

              // If Android ID is already available, send immediately
              if (androidId !== null) {
                sendToClient(client, { type: 'ANDROID_ID', id: androidId });
              }
              break;
            }

            // Child requests Android ID
            case 'REQUEST_ANDROID_ID': {
              broadcast({ type: 'ANDROID_ID', id: androidId });
              break;
            }

            // Optional: child unregisters
            case 'UNREGISTER_ANDROID_BRIDGE': {
              for (let c of Array.from(clients)) {
                if (c.source === event.source) clients.delete(c);
              }
              break;
            }

            default:
              break;
          }
        },
        false
      );

      // Debug: list clients in console
      window._listBridgeClients = function () {
        return Array.from(clients).map(c => ({
          origin: c.origin,
          hasSource: !!c.source,
        }));
      };

      // Example: native can call
      // webView.evaluateJavascript("window.setAndroidId('ANDROID12345')", null);
    })();
  </script>
</body>
</html>
